<!doctype html>
<html>

<head>
  <meta charset=utf-8>
  <meta name=viewport content='width=device-width,initial-scale=1'>
  <title>bip322.rs</title>
  <link href=index.css rel=stylesheet type=text/css>
</head>

<body>
  <div id="verify">
    <div id="bip"></div>
    <form id="verify-form">
      <input type="text" id="address" value="bc1ppv609nr0vr25u07u95waq5lucwfm6tde4nydujnu8npg4q75mr5sxq8lt3" required>
      <input type="text" id="message" value="Hello World" required></textarea>
      <input type="text" id="signature"
        value="AUHd69PrJQEv+oKTfZ8l+WROBHuy9HKrbFCJu7U1iK2iiEy1vMU5EfMtjc+VSHM7aU0SDbak5IUZRVno2P5mjSafAQ==" required>
      <button type="submit" id="verify-button">verify</button>
    </form>
  </div>
  <nav class="navbar" id="navbar">
    <a href=https://github.com/bitcoin/bips/blob/master/bip-0322.mediawiki>bip</a>
    <a href=https://github.com/raphjaph/bip322>github</a>
    <a href=https://crates.io/crates/bip322>crate</a>
  </nav>

  <script type="module">
    import init, {verify} from './www.js';

    let wasmInitialized = false;

    async function initializeWasm() {
      if (!wasmInitialized) {
        await init();
        console.log('WASM module loaded');
        wasmInitialized = true;
      }
    }

    async function runVerification(event) {
      event.preventDefault();
      await initializeWasm();

      const address = document.getElementById('address').value;
      const message = document.getElementById('message').value;
      const signature = document.getElementById('signature').value;

      const result = verify(address, message, signature);
      console.log(result);

      document.getElementById('verify-form').style.display = 'none';
      const resultElement = document.getElementById('verify');
      resultElement.textContent = result;
      resultElement.style.display = 'block';
    }

    function showForm() {
      document.getElementById('navbar').style.display = 'none';
      document.getElementById('bip').classList.add('hidden');
      document.getElementById('verify-form').classList.add('visible');
    }

    function handleFocus(event) {
      if (event.target.value === event.target.getAttribute('data-default')) {
        event.target.value = '';
      }
    }

    function handleBlur(event) {
      if (event.target.value === '') {
        event.target.value = event.target.getAttribute('data-default');
      }
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        runVerification(event);
      }
    }

    document.getElementById('bip').addEventListener('click', showForm);
    document.getElementById('verify-form').addEventListener('submit', runVerification);

    const inputs = document.querySelectorAll('#verify-form input');
    inputs.forEach(input => {
      const defaultValue = input.value;
      input.setAttribute('data-default', defaultValue);
      input.addEventListener('focus', handleFocus);
      input.addEventListener('blur', handleBlur);
      input.addEventListener('keypress', handleKeyPress);
    });
  </script>
</body>

</html>
